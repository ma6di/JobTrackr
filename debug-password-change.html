<!DOCTYPE html>
<html>
<head>
    <title>Debug Change Password</title>
</head>
<body>
    <h1>Debug Change Password Issue</h1>
    
    <h2>Step 1: Login</h2>
    <button onclick="testLogin()">Test Login</button>
    
    <h2>Step 2: Test Change Password</h2>
    <button onclick="testChangePassword()" disabled id="changeBtn">Test Change Password</button>
    
    <h2>Results:</h2>
    <div id="results" style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 10px;"></div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        let authToken = null;
        const resultsDiv = document.getElementById('results');
        
        function log(message) {
            resultsDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }
        
        async function testLogin() {
            log('Testing login...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                const responseText = await response.text();
                log(`Login response status: ${response.status}`);
                log(`Login response: ${responseText}`);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    authToken = data.token;
                    document.getElementById('changeBtn').disabled = false;
                    log('Login successful! Token received.');
                } else {
                    log('Login failed. You may need to register first or check credentials.');
                }
            } catch (error) {
                log(`Login error: ${error.message}`);
            }
        }
        
        async function testChangePassword() {
            if (!authToken) {
                log('No auth token! Please login first.');
                return;
            }
            
            log('Testing change password...');
            
            try {
                const requestBody = {
                    currentPassword: 'password123',
                    newPassword: 'MyNewPass123!'
                };
                
                log(`Request URL: PUT ${API_BASE_URL}/users/change-password`);
                log(`Request headers: Authorization: Bearer [token], Content-Type: application/json`);
                log(`Request body: ${JSON.stringify(requestBody, null, 2)}`);
                
                const response = await fetch(`${API_BASE_URL}/users/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const responseText = await response.text();
                log(`Change password response status: ${response.status}`);
                log(`Change password response headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`);
                log(`Change password response: ${responseText}`);
                
                if (response.ok) {
                    log('✅ Password change successful!');
                } else {
                    log('❌ Password change failed!');
                    
                    // Try to parse as JSON to see error details
                    try {
                        const errorData = JSON.parse(responseText);
                        log(`Error details: ${JSON.stringify(errorData, null, 2)}`);
                    } catch (e) {
                        log('Response was not valid JSON');
                    }
                }
            } catch (error) {
                log(`Change password error: ${error.message}`);
                log(`Error stack: ${error.stack}`);
            }
        }
    </script>
</body>
</html>
