<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobTracker Login Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
        button { margin: 5px; padding: 10px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h1>JobTracker Login Flow Debug Test</h1>
    
    <div class="section">
        <h2>Step 1: Clear All Storage</h2>
        <button onclick="clearStorage()">Clear localStorage & sessionStorage</button>
        <div id="storage-status"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test Backend API</h2>
        <button onclick="testBackend()">Test Backend Health</button>
        <button onclick="testLogin()">Test Login API</button>
        <div id="backend-status"></div>
    </div>

    <div class="section">
        <h2>Step 3: Simulate Frontend Flow</h2>
        <button onclick="simulateLogin()">Simulate Full Login Flow</button>
        <button onclick="simulateLogout()">Simulate Logout Flow</button>
        <div id="frontend-status"></div>
    </div>

    <div class="section">
        <h2>Step 4: Check Auth State</h2>
        <button onclick="checkAuthState()">Check Current Auth State</button>
        <div id="auth-status"></div>
    </div>

    <div class="section">
        <h2>Debug Logs</h2>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="debug-logs"></div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3001/api';
        const FRONTEND_URL = 'http://localhost:5174';
        
        // Test credentials
        const TEST_EMAIL = 'test@example.com';
        const TEST_PASSWORD = 'TestPassword123!';

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debug-logs');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }

        // Token management functions
        const getToken = () => localStorage.getItem('authToken');
        const setToken = (token) => localStorage.setItem('authToken', token);
        const removeToken = () => localStorage.removeItem('authToken');
        const isAuthenticated = () => !!getToken();

        // Clear all storage
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Storage cleared', 'success');
            document.getElementById('storage-status').innerHTML = '<div class="success">✅ All storage cleared</div>';
        }

        // Generic API request function
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
            };
            
            const token = getToken();
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }

            const config = {
                method: 'GET',
                headers,
                ...options,
            };

            if (options.headers) {
                config.headers = { ...config.headers, ...options.headers };
            }

            log(`Making ${config.method} request to ${url}`);

            try {
                const response = await fetch(url, config);
                
                log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Request failed' }));
                    let errorMessage = errorData.error || response.statusText;
                    
                    if (response.status === 401) {
                        errorMessage = errorData.error || 'Invalid credentials';
                    } else if (response.status === 429) {
                        errorMessage = 'Too many requests. Please try again later.';
                    } else if (response.status === 500) {
                        errorMessage = 'Server error. Please try again later.';
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                log(`Response received: ${JSON.stringify(result, null, 2)}`);
                return result;
                
            } catch (error) {
                log(`API Request failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test backend health
        async function testBackend() {
            try {
                log('Testing backend health...');
                const response = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                const data = await response.json();
                log('Backend health response:', 'success');
                log(JSON.stringify(data, null, 2), 'success');
                document.getElementById('backend-status').innerHTML = '<div class="success">✅ Backend is running</div>';
            } catch (error) {
                log(`Backend health check failed: ${error.message}`, 'error');
                document.getElementById('backend-status').innerHTML = '<div class="error">❌ Backend not responding</div>';
            }
        }

        // Test login API
        async function testLogin() {
            try {
                log('Testing login API...');
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email: TEST_EMAIL, password: TEST_PASSWORD }),
                });
                
                if (response.token) {
                    setToken(response.token);
                    log('Login successful! Token stored.', 'success');
                    document.getElementById('backend-status').innerHTML = '<div class="success">✅ Login API working</div>';
                } else {
                    log('Login response missing token', 'error');
                    document.getElementById('backend-status').innerHTML = '<div class="error">❌ Login API issue</div>';
                }
            } catch (error) {
                log(`Login API test failed: ${error.message}`, 'error');
                document.getElementById('backend-status').innerHTML = '<div class="error">❌ Login API failed</div>';
            }
        }

        // Simulate full login flow
        async function simulateLogin() {
            try {
                log('Starting full login simulation...');
                
                // Step 1: Clear existing auth
                removeToken();
                log('Cleared existing token');
                
                // Step 2: Login
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email: TEST_EMAIL, password: TEST_PASSWORD }),
                });
                
                // Step 3: Store token
                if (response.token) {
                    setToken(response.token);
                    log('Token stored successfully', 'success');
                } else {
                    throw new Error('No token in response');
                }
                
                // Step 4: Verify token works
                const userResponse = await apiRequest('/auth/me');
                log('User data retrieved successfully:', 'success');
                log(JSON.stringify(userResponse, null, 2), 'success');
                
                // Step 5: Simulate navigation
                log('Login flow complete. In real app, would navigate to /dashboard', 'success');
                document.getElementById('frontend-status').innerHTML = '<div class="success">✅ Full login flow successful</div>';
                
            } catch (error) {
                log(`Login simulation failed: ${error.message}`, 'error');
                document.getElementById('frontend-status').innerHTML = '<div class="error">❌ Login simulation failed</div>';
            }
        }

        // Simulate logout flow
        async function simulateLogout() {
            try {
                log('Starting logout simulation...');
                
                // Step 1: Call logout API
                await apiRequest('/auth/logout', {
                    method: 'POST'
                });
                log('Backend logout successful');
                
                // Step 2: Clear token
                removeToken();
                log('Token removed locally', 'success');
                
                // Step 3: Verify logout
                try {
                    await apiRequest('/auth/me');
                    log('Warning: Still authenticated after logout', 'error');
                } catch (error) {
                    log('Logout verified - no longer authenticated', 'success');
                }
                
                log('Logout flow complete. In real app, would navigate to /login', 'success');
                document.getElementById('frontend-status').innerHTML = '<div class="success">✅ Logout flow successful</div>';
                
            } catch (error) {
                // Logout might fail if not authenticated, but still clear token
                removeToken();
                log(`Logout simulation: ${error.message} (token cleared anyway)`, 'success');
                document.getElementById('frontend-status').innerHTML = '<div class="success">✅ Logout completed</div>';
            }
        }

        // Check current auth state
        function checkAuthState() {
            const token = getToken();
            const authenticated = isAuthenticated();
            
            log('Current authentication state:');
            log(`Authenticated: ${authenticated}`);
            log(`Token exists: ${!!token}`);
            if (token) {
                log(`Token preview: ${token.substring(0, 50)}...`);
            }
            
            const statusHtml = `
                <div>
                    <strong>Authentication State:</strong><br>
                    Is Authenticated: ${authenticated ? '✅' : '❌'}<br>
                    Token: ${token ? '✅ Present' : '❌ Missing'}<br>
                    ${token ? `Token Preview: ${token.substring(0, 50)}...` : ''}
                </div>
            `;
            document.getElementById('auth-status').innerHTML = statusHtml;
        }

        // Initialize
        log('Debug test page loaded');
        log(`API URL: ${API_BASE_URL}`);
        log(`Frontend URL: ${FRONTEND_URL}`);
    </script>
</body>
</html>
